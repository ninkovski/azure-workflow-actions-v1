name: Deploy Azure Function (Reusable)

on:
  workflow_call:
    inputs:
      function-app-name:
        description: 'Azure Function App name'
        required: true
        type: string
      resource-group:
        description: 'Azure Resource Group'
        required: true
        type: string
      environment:
        description: 'Deployment environment (dev, staging, prod)'
        required: true
        type: string
      package-path:
        description: 'Path to function app'
        required: false
        type: string
        default: '.'
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '18.x'
      run-tests:
        description: 'Run tests before deployment'
        required: false
        type: boolean
        default: true
      slot-name:
        description: 'Deployment slot name'
        required: false
        type: string
        default: ''
      enable-notifications:
        description: 'Enable deployment notifications'
        required: false
        type: boolean
        default: true
      notification-type:
        description: 'Notification type (teams, email, all)'
        required: false
        type: string
        default: 'teams'
      create-release-on-success:
        description: 'Create release after successful deployment'
        required: false
        type: boolean
        default: false
    outputs:
      deployment-url:
        description: 'Deployed function URL'
        value: ${{ jobs.deploy.outputs.deployment-url }}
      deployment-status:
        description: 'Deployment status'
        value: ${{ jobs.deploy.outputs.deployment-status }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      deployment-url: ${{ steps.deploy-function.outputs.deployment-url }}
      deployment-status: ${{ steps.deploy-function.outputs.deployment-status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests
        if: inputs.run-tests
        uses: ${{ github.repository_owner }}/${{ github.event.repository.name }}/.github/actions/run-tests@main
        with:
          project-type: 'nodejs'
          working-directory: ${{ inputs.package-path }}
          node-version: ${{ inputs.node-version }}

      - name: Deploy Azure Function
        id: deploy-function
        uses: ${{ github.repository_owner }}/${{ github.event.repository.name }}/.github/actions/deploy-azure-function@main
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        with:
          function-app-name: ${{ inputs.function-app-name }}
          resource-group: ${{ inputs.resource-group }}
          package-path: ${{ inputs.package-path }}
          environment: ${{ inputs.environment }}
          node-version: ${{ inputs.node-version }}
          run-tests: 'false'  # Tests already ran
          slot-name: ${{ inputs.slot-name }}

      - name: Send Success Notification
        if: success() && inputs.enable-notifications
        uses: ${{ github.repository_owner }}/${{ github.event.repository.name }}/.github/actions/notify-deployment@main
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        with:
          environment: ${{ inputs.environment }}
          status: 'success'
          deployment-url: ${{ steps.deploy-function.outputs.deployment-url }}

      - name: Send Failure Notification
        if: failure() && inputs.enable-notifications
        uses: ${{ github.repository_owner }}/${{ github.event.repository.name }}/.github/actions/notify-deployment@main
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        with:
          environment: ${{ inputs.environment }}
          status: 'failure'
          app-name: ${{ inputs.function-app-name }}

  create-release:
    needs: deploy
    if: inputs.create-release-on-success && success()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Release
        uses: ${{ github.repository_owner }}/${{ github.event.repository.name }}/.github/actions/create-release@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          environment: ${{ inputs.environment }}
          deployment-url: ${{ needs.deploy.outputs.deployment-url }}
          prerelease: ${{ inputs.environment != 'prod' }}
